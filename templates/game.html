<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„Ø¹Ø¨Ø© Ø¨Ù„Ù†ÙƒÙˆ - Fast Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: url("{{ url_for('static', filename='game_web.jpg') }}") center/cover no-repeat fixed;
      color: #fff;
      overflow: hidden;
    }

    @media (max-width: 768px) {
      body { background-image: url("{{ url_for('static', filename='game_mobile.jpg') }}"); }
    }

    .app {
      width: 100%;
      max-width: 420px;
      height: 90vh;
      max-height: 850px;
      background: rgba(2, 6, 23, 0.95);
      border-radius: 24px;
      border: 1px solid rgba(148,163,184,0.3);
      padding: 12px;
      display: flex;
      flex-direction: column;
      position: relative;
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
    }

    .header { text-align: center; margin-bottom: 10px; }
    .title { font-size: 20px; font-weight: 900; color: #f59e0b; }
    .subtitle { font-size: 11px; color: #94a3b8; }

    .stats-row { display: flex; gap: 8px; margin-bottom: 10px; }
    .stat-card {
      flex: 1;
      background: linear-gradient(180deg, #1e293b, #0f172a);
      border: 1px solid #334155;
      padding: 10px;
      border-radius: 12px;
      text-align: center;
    }
    .stat-label { font-size: 10px; color: #94a3b8; }
    .stat-value { font-size: 18px; font-weight: 700; }
    .win-text { color: #facc15; }
    .ball-text { color: #4ade80; }

    .canvas-wrapper {
      flex: 1;
      border: 2px solid #1e40af;
      border-radius: 18px;
      overflow: hidden;
      background: radial-gradient(circle at 50% 20%, #1e1b4b, #000);
    }

    canvas { width: 100%; height: 100%; display: block; }

    .controls { display: flex; gap: 10px; margin-top: 12px; padding-bottom: 25px; }
    .main-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-weight: 900;
      font-size: 15px;
      cursor: pointer;
    }

    .btn-drop { background: linear-gradient(135deg, #f59e0b, #d97706); color: #000; }
    .btn-drop:disabled { opacity: 0.5; }

    .btn-cashout {
      background: linear-gradient(135deg, #22c55e, #15803d);
      color: #fff;
    }
    .btn-cashout:disabled { opacity: 0.5; }

    .toast {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 12px 24px;
      border-radius: 12px;
      border: 1px solid #f59e0b;
      color: #f59e0b;
      font-weight: bold;
      opacity: 0;
      transition: 0.3s;
      pointer-events: none;
    }
    .toast.show { opacity: 1; }
  </style>
</head>

<body>
<div class="app">

  <div class="header">
    <div class="title">Ù„Ø¹Ø¨Ø© Ø¨Ù„Ù†ÙƒÙˆ ğŸ”¥</div>
    <div class="subtitle">Ø§Ù„Ù†ØªÙŠØ¬Ø© ØªÙØ­Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±</div>
  </div>

  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</div>
      <div class="stat-value win-text" id="winDisplay">0.00 Ø¯.Ùƒ</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Ø§Ù„ÙƒØ±Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</div>
      <div class="stat-value ball-text" id="ballDisplay">0</div>
    </div>
  </div>

  <div class="canvas-wrapper">
    <canvas id="gameCanvas" width="360" height="640"></canvas>
  </div>

  <div class="controls">
    <button class="main-btn btn-drop" id="dropBtn">â¬‡ Ù†Ø²Ù‘Ù„ Ø§Ù„ÙƒØ±Ø©</button>
    <button class="main-btn btn-cashout" id="cashoutBtn" disabled>ğŸ’° Ø¥Ù†Ù‡Ø§Ø¡</button>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
(() => {

  /* ------------------------------
     SERVER-ALIGNED SLOT VALUES
     TRUE BELL CURVE (CENTER LOWEST)
  --------------------------------*/
  const SLOT_VALUES = [
    100, 50, 25, 10, 5,
    2, 1, 0,
    1, 2,
    5, 10, 25, 50, 100
  ];
  const SLOT_COUNT = SLOT_VALUES.length;

  let currentBalls = parseInt("{{ balance }}");
  let currentWinnings = parseFloat("{{ winnings }}");

  const ballDisplay = document.getElementById("ballDisplay");
  const winDisplay = document.getElementById("winDisplay");
  const dropBtn = document.getElementById("dropBtn");
  const cashoutBtn = document.getElementById("cashoutBtn");
  const toast = document.getElementById("toast");

  ballDisplay.textContent = currentBalls;
  winDisplay.textContent = currentWinnings.toFixed(2) + " Ø¯.Ùƒ";

  function showToast(t) {
    toast.textContent = t;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2000);
  }

  /* ------------------------------
     CANVAS + BOARD
  --------------------------------*/
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  const width = canvas.width;
  const height = canvas.height;

  const slotY = height - 90;
  const slotW = width / SLOT_COUNT;

  const pegs = [];
  const balls = [];

  function initBoard() {
    pegs.length = 0;
    const rows = 13;
    const spacingY = 36;
    const usableW = width - 40;

    for (let r = 0; r < rows; r++) {
      const count = r + 1;
      const gap = usableW / count;
      const startX = (width - gap * (count - 1)) / 2;
      const y = 60 + r * spacingY;

      for (let c = 0; c < count; c++) {
        pegs.push({ x: startX + c * gap, y });
      }
    }
  }

  function spawnBall(slotIndex, totalWin, winAmt, gameOver) {
    balls.push({
      x: width / 2,
      y: 40,
      vx: (Math.random() - 0.5) * 40,
      vy: 0,
      r: 6,
      targetX: slotIndex * slotW + slotW / 2,
      winAmt,
      totalWin,
      gameOver
    });
  }

  async function dropBall() {
    if (currentBalls <= 0) return;

    dropBtn.disabled = true;

    const res = await fetch("/api/drop", { method: "POST" });
    const data = await res.json();

    if (!res.ok) {
      showToast("Ø®Ø·Ø£");
      dropBtn.disabled = false;
      return;
    }

    currentBalls -= 1;
    ballDisplay.textContent = currentBalls;

    spawnBall(
      data.slot_index,
      data.new_winnings,
      data.win_amount,
      data.game_over
    );

    if (data.game_over) cashoutBtn.disabled = false;
  }

  function update(dt) {
    for (let i = balls.length - 1; i >= 0; i--) {
      const b = balls[i];

      b.vy += 2200 * dt;
      b.x += b.vx * dt;
      b.y += b.vy * dt;

      b.vx += (b.targetX - b.x) * 0.002;

      if (b.y >= slotY) {
        currentWinnings = b.totalWin;
        winDisplay.textContent = currentWinnings.toFixed(2) + " Ø¯.Ùƒ";

        if (b.winAmt > 0) showToast("+" + b.winAmt + " Ø¯.Ùƒ");
        balls.splice(i, 1);

        if (currentBalls <= 0) cashoutBtn.disabled = false;
      }
    }
  }

  function draw() {
    ctx.clearRect(0, 0, width, height);

    ctx.fillStyle = "#fff";
    pegs.forEach(p => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
      ctx.fill();
    });

    for (let i = 0; i < SLOT_COUNT; i++) {
      ctx.fillStyle = "#1e293b";
      ctx.fillRect(i * slotW, slotY, slotW - 1, 80);

      ctx.save();
      ctx.translate(i * slotW + slotW / 2, slotY + 40);
      ctx.rotate(-Math.PI / 2);
      ctx.fillStyle = "#fff";
      ctx.font = "bold 11px Cairo";
      ctx.fillText(SLOT_VALUES[i] + " Ø¯.Ùƒ", 0, 4);
      ctx.restore();
    }

    balls.forEach(b => {
      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
      ctx.fillStyle = "#fbbf24";
      ctx.fill();
    });
  }

  let last = 0;
  function loop(ts) {
    const dt = Math.min((ts - last) / 1000, 0.03);
    last = ts;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  dropBtn.onclick = dropBall;
  cashoutBtn.onclick = async () => {
    await fetch("/api/finish", { method: "POST" });
    window.location.href = "{{ url_for('result') }}";
  };

  initBoard();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
